FROM quay.io/openmake/meister:v7_5_1 AS builder

WORKDIR /build/

COPY . /workspace
RUN /workspace/tgt/build-gen.sh

FROM quay.io/ortelius/ortelius-base:fedora-34-v1_0_1

WORKDIR /opt/deployhub/
COPY --from=builder /workspace/installers/linux/webadmin/webapp-runner.jar webadmin/webapp-runner.jar
COPY --from=builder /build/dh-ms-general.war webadmin/deployhub-webadmin.war
COPY --from=builder /workspace/docker/entrypoint.sh .
RUN sudo pip install --upgrade deployhub
RUN sudo pip -y uninstall setuptools pip

WORKDIR /etc/nginx/

RUN sudo yum -y install nginx; \
    sudo mkdir /etc/nginx/location; \
    sudo mkdir /var/www; \
    sudo yum -y upgrade
    
COPY dmadminweb/microservice/nginx-onprem.conf  /etc/nginx/nginx.conf
COPY dmadminweb/microservice/location/  /etc/nginx/location/

WORKDIR /opt/deployhub/
USER omreleng
ENTRYPOINT /opt/deployhub/entrypoint.sh
