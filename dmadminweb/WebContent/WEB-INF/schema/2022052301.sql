CREATE OR REPLACE FUNCTION dm.snapshot_comps_for_deployment() RETURNS trigger AS $$ BEGIN IF (select count(*) from dm.dm_application a, dm.dm_deployment b where a.id = b.appid and a.isrelease = 'N' and b.deploymentid = NEW.deploymentid)  > 0 THEN insert into dm.dm_deploymentcomps (deploymentid, compid) (select  b.deploymentid, a.compid from dm.dm_applicationcomponent a, dm.dm_deployment b where a.appid = b.appid and b.deploymentid = NEW.deploymentid); END IF; RETURN NULL; END; $$ LANGUAGE plpgsql;
